name: Deploy Laravel to VPS

on:
  push:
    branches: ["main"]          # <-- change if your default branch isn't main
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      # Quick sanity check that the SSH key in secrets works
      - name: "Test SSH connectivity"
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            whoami
            hostname
            ls -la /var/www/html

      - name: "Rsync code to server (skip env/vendor)"
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: "-az --delete --no-perms --no-owner --no-group --exclude=.git --exclude=.github --exclude=node_modules --exclude=vendor --exclude=.env"
          path: ./
          remote_path: /var/www/html/socialcraft/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_port: ${{ secrets.SSH_PORT }}
          remote_key: ${{ secrets.SSH_KEY }}

      - name: "Post-deploy: composer, caches, migrate, reload"
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd /var/www/html/socialcraft

            # Ensure Composer exists
            if ! command -v composer >/dev/null 2>&1; then
              php -r "copy('https://getcomposer.org/installer','composer-setup.php');"
              php composer-setup.php --install-dir=/usr/local/bin --filename=composer
              php -r "unlink('composer-setup.php');"
            fi

            # Install PHP dependencies for production
            composer install --no-dev --prefer-dist --no-interaction --no-progress

            # First-time app key if missing
            grep -q "^APP_KEY=" .env || php artisan key:generate --force || true

            # Optimize Laravel caches
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan storage:link || true

            # Run database migrations (optional)
            php artisan migrate --force || true

            # Fix runtime permissions (adjust user/group if needed)
            chown -R www-data:www-data storage bootstrap/cache || true
            find storage -type d -exec chmod 775 {} \;
            find storage -type f -exec chmod 664 {} \;
            chmod -R 775 bootstrap/cache

            # Reload web services (whichever exists on your box)
            systemctl reload apache2 || true
            systemctl reload php8.3-fpm || systemctl reload php8.2-fpm || true
            systemctl reload nginx || true
